// app/views/periods/create.js.erb
// Here you will write *javascript* that would be executed by the browser
var date_picker = function(){

  var max_date = "";

  if ($('#user_last_entry').val()) {
    max_date = $('#user_last_entry').val();
  }

  $(".latest_planned").datepicker({
    dateFormat: "MM dd, yy",
    defaultDate: 0,
    defaultDate: 0,
    changeMonth: false,
    numberOfMonths: 1,
    onClose: function( selectedDate ) {
      $( ".last_day").datepicker( "option", {"maxDate": selectedDate, "defaultDate": 0} );
      $( ".first_day").datepicker( "option", {"maxDate": selectedDate, "defaultDate": 0} );
      $(this).change();
    }
  });

  $( ".first_day" ).datepicker({
    dateFormat: "MM dd, yy",
    defaultDate: 0,
    // maxDate: 0,
    maxDate: max_date,
    defaultDate: 0,
    changeMonth: false,
    numberOfMonths: 1,
    onClose: function( selectedDate ) {
      if (selectedDate) {
        $(this).parents('.form-inputs').find( ".last_day").datepicker( "option", {"minDate": selectedDate, "defaultDate": selectedDate} );
        $(this).change();
      }
    }
  });
  $( ".last_day" ).datepicker({
    dateFormat: "MM dd, yy",
    defaultDate: +1,
    // maxDate: 0,
    maxDate: max_date,
    changeMonth: false,
    numberOfMonths: 1,
    onClose: function( selectedDate ) {
      if (selectedDate) {
        $(this).parents('.form-inputs').find( ".first_day").datepicker( "option", {"maxDate": selectedDate, "defaultDate": selectedDate} );
        $(this).change();
      }
    }
  });
};

var validate_submit = function() {
  var first_day_input = $('#all_stays .first_day');
  var last_day_input = $('#all_stays .last_day');
  var latest_planned_input = $('#user_last_entry');

  if (first_day_input.val() != '' && last_day_input.val() != '') {
    first_day_input.parents('.form-inputs').find('.stay_submit').prop("disabled", false);
  } else {
    first_day_input.parents('.form-inputs').find('.stay_submit').prop("disabled", true);
  }

  if (latest_planned_input.val() != '') {
    $('#calculate').prop("disabled", false);
  } else {
    $('#calculate').prop("disabled", true);
  }

  //on change
  first_day_input.change(function() {
    var last_day_val = $(this).parents('.form-inputs').find('.last_day').val();
    if ($(this).val() != '' && last_day_val != '') {
      $(this).parents('.form-inputs').find('.stay_submit').prop("disabled", false);
    } else {
      $(this).parents('.form-inputs').find('.stay_submit').prop("disabled", true);
    }
  });

  last_day_input.change(function() {
    var last_day_val = $(this).parents('.form-inputs').find('.first_day').val();
    if ($(this).val() != '' && last_day_val != '') {
      $(this).parents('.form-inputs').find('.stay_submit').prop("disabled", false);
    } else {
      $(this).parents('.form-inputs').find('.stay_submit').prop("disabled", true);
    }
  });

  latest_planned_input.change(function() {
    if ($(this).val() != '') {
      $('#calculate').prop("disabled", false);
    } else {
      $('#calculate').prop("disabled", true);
    }
  });
};


<% if @period.errors.any? %>
  // Render new comment form with errors
  $('#new_period_form').html("<%= j render 'periods/form', period: @period %>");
  date_picker();
  validate_submit();
<% else %>

  //change btn content to loader
  btn_text = $('#stay_submit').html();
  $('#stay_submit').html('<i class="fa fa-spinner fa-spin fa-fw"></i>');

  // Create a paragraph for the new comment. But hide it.
  var all_periods = $("<%= j render 'periods/all_periods', periods: @period.user.periods.order(:last_day) %>").hide();
  // var new_period = $("<%= j render 'periods/show', period: @period %>").hide();
  // Add it to the DOM, at the end of the existing comments. It's still hidden.
  $('#all_stays table tbody').html(all_periods);
  // $('#all_stays table tbody').append(new_period);

  // Show the new comment with an animation!
  all_periods.show();
  // new_period.slideDown();
  // Remove the text from the content textarea.
  $('#period-0-first-day').val('');
  $('#period-0-last-day').val('');
  validate_submit();

  var max_date = "";

  if ($('#user_last_entry').val()) {
    max_date = $('#user_last_entry').val();
  }

  $( ".first_day" ).datepicker( "option",
    "maxDate", max_date
  );
  $( ".last_day" ).datepicker( "option",
    "maxDate", max_date
  );

  $('#stay_submit').html(btn_text);

<% end %>